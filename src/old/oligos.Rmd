---
title: "subset oligos"
author: "Nadine Bestard"
date: "12/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set-up


```{r set-up, message=FALSE, warning=FALSE}
library(here) # for reproducible paths
library(SingleCellExperiment)
library(scater) # For qcs
library(dplyr) # df manipulation
library(scran) # For feature selcetion
library(ggplot2) # To add titles to plots
library(batchelor) # Batch correction
```

## Import

```{r}
project <- "old"
sce <- readRDS(here("processed", project, "sce_anno_02.RDS"))
sce <- sce[, sce$celltype %in% c("OPCs", "Oligo")]

```

# Cell and gene QC

We need to bear in mind this dataset comes from a bigger dataset where outliers have already been excluded. 


## Violin plots

```{r}
plotColData(sce, x = "Sample", y = "sum") +
  ggtitle("Total count") 

plotColData(sce, x = "Sample", y = "sum") +
  scale_y_log10() + ggtitle("Total count log scale") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

plotColData(sce, x = "Sample", y = "detected") +
  scale_y_log10() + ggtitle("Detected Genes") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

plotColData(sce, x = "Sample", y = "sum", colour_by = "chip") +
  scale_y_log10() + ggtitle("total count by batch") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotColData(sce, x = "Sample", y = "sum", colour_by = "celltype") +  scale_color_discrete() +
  scale_y_log10() + ggtitle("total count by tissue") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
plotColData(sce, x = "Sample", y = "sum", colour_by = "genotype") +
  scale_y_log10() + ggtitle("total count by genotype") +
  scale_colour_manual(values = c("#E25822", "#888888")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

plotColData(sce, x = "Sample", y = "subsets_mt_percent") +
  ggtitle("Mitocchondrial percentatge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))


```

## Histograms

 
```{r}
hist(
  sce$detected,
  breaks = 100
)

hist(
  sce$subsets_mt_percent,
  breaks = 100
)
hist(
  sce$sum,
  breaks = 100
)
```

## Scatter plots

```{r}
plotColData(sce, x = "sum", y = "detected", colour_by = "Sample")
plotColData(sce, x = "sum", y = "subsets_mt_percent", colour_by = "Sample", size_by = "celltype")
plotColData(sce, x = "sum", y = "subsets_mt_percent", colour_by = "chip")
plotColData(sce, x = "sum", y = "subsets_mt_percent", colour_by = "genotype", size_by = "celltype")
plotColData(sce, x = "sum", y = "subsets_mt_percent", colour_by = "celltype", size_by = "celltype") + scale_color_discrete()
plotColData(sce, x = "detected", y = "subsets_mt_percent", colour_by = "celltype", size_by = "celltype") + scale_color_discrete()
```

sample S1826 has more Oligo cells with lower counts. Cutting at 
minimum 5000 umi counts will get rid of them. for the OPCs we can cut at 2500.

We can also cut at 10% mt genes for both celltypes. 

## Dimensional redution

This is the dimensional reduction done with the whole dataset, not as accurate as the one we will compute later, with only the oligos and OPCs
```{r}
plotTSNE(sce, colour_by = "chip", point_size = 0.2)
plotTSNE(sce, colour_by = "genotype", point_size = 0.2)
plotTSNE(sce, colour_by = "detected", point_size = 0.2)
plotTSNE(sce, colour_by = "sum", point_size = 0.2)
plotTSNE(sce, colour_by = "subsets_mt_percent", point_size = 0.2)
```


## Tables

```{r tables, paged.print=TRUE}
  table(sce$Sample, sce$celltype) %>% 
  as.data.frame.matrix() %>% 
  select(c("OPCs", "Oligo"))
table(sce$genotype, sce$celltype) %>% 
  as.data.frame.matrix() %>% 
  select(c("OPCs", "Oligo"))
```


## Subset to the best quality cells and delete non detectable genes


```{r}
# filter cells
keep_cells <- 
  # for oligos
  (sce$sum >= 5000 & sce$detected >= 2000 & sce$celltype == "Oligo" | # for oligos
     # for opcs
     sce$sum >= 2500 & sce$celltype == "OPCs" )  &
  # for both
  sce$subsets_mt_percent <= 10 
print("before filtering")
dim(sce)
# filter cells
sce <- sce[, keep_cells ]
# filter genes
keep_feature <- rowSums(counts(sce) > 0) > 1
sce <- sce[keep_feature, ]
print("after filtering")
dim(sce)

```


result: 
```{r}
plotColData(sce, x = "Sample", y = "sum", colour_by = "celltype") +
  scale_y_log10() + ggtitle("total count after filering") +  scale_color_discrete() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```


# Feature selection and dimensional reduction

## Quantify per-gene variation

We quantify per-gene variation computing the variance of the log-normalized expression values (referred to as "log-counts" for simplicity) for each gene across all cells in the population (A. T. L. Lun, McCarthy, and Marioni 2016). We use modelGeneVar() that does also corrects for the abundance of each gene.

```{r}
#The density weights are removed because the genes
# with highest mean abundance are also HVG, this avoids overfiting
gene_var_df <- modelGeneVar(sce, density.weights=FALSE )
gene_var <- metadata(gene_var_df)
plot(gene_var$mean, gene_var$var, xlab= "Mean of log-expression", ylab= "Variance of log-expression")
curve(gene_var$trend(x), lwd=2, add=T, col = "red")
```

## Select the HVGs

The next step is to select the subset of HVGs to use in downstream analyses. The simplest HVG selection strategy is to take the top X genes with the largest values for the relevant variance metric. Here I select the top 15 % of genes.

```{r}
hvgs <- getTopHVGs(gene_var_df, prop=0.15)
# save them in the object
rowSubset(sce) <- hvgs
```

This leaves us with `r length(hvgs)` highly variable genes.

## Run PCA and choose PCs

Here we recompute the dimensional reduction to better fit our subsetted oligo data. This will remove the 
dimensional batch correction performed earlier, that will be recomputed. 

```{r pca}
# Delete all previous dimensions, done with all genes, to not use the wrong ones
reducedDims(sce) <- NULL
# re-run pca
set.seed(1000)
sce <- runPCA(sce)
```


```{r pca-plots}
pct_var <- attr(reducedDim(sce, "PCA"), "percentVar")
plot(pct_var, log="y", xlab="PC", ylab="pct variance explained")
# rerun PCA
reducedDim(sce, "PCA") <- reducedDim(sce, "PCA")[,1:25]
# rerun TSNE if it's not already done
set.seed(1000)
sce <- runTSNE(sce)
sce <- runUMAP(sce)
plotReducedDim(sce, "TSNE", colour_by = "celltype") + scale_color_discrete()
plotReducedDim(sce, "UMAP", colour_by = "celltype") + scale_color_discrete()
plotReducedDim(sce, "UMAP", colour_by = "genotype")

if (!file.exists(here("processed", project, "sce_oligo.RDS"))) {
  # save results
  saveRDS(sce, here("processed", project, "sce_oligo.RDS") )
}
```

---
title: "Normalisation"
author: "NadineBestard"
date: "08/03/2021"
output: html_document
---

# Set-up
```{r set-up, message=FALSE, warning=FALSE}
library(here) # for reproducible paths
library(SingleCellExperiment)
library(scater) # For qc
library(scran) # For normalisation
```

```{r load-sce}
sce <- readRDS(here("processed", "sce_QC.RDS"))
```

# Normalisation by deconvolution

In order to correct for systematic differences in sequencing coverage between libraries we will normalise the dataset. This involves dividing all counts for each cell by a cell-specific scaling factor, often called a “size factor” (Anders and Huber 2010). The assumption here is that any cell-specific bias (e.g., in capture or amplification efficiency) affects all genes equally via scaling of the expected mean count for that cell. The size factor for each cell represents the estimate of the relative bias in that cell, so division of its counts by its size factor should remove that bias.

Specifically we will used the deconvolution method available in the `scran` package. This method allows to take in consideration the composition bias between samples [(Lun et al., 2016)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4848819/)

```{r}
# For reproducibility
set.seed(100)
# Quick clustering to pool samples together and deal with 0 counts
clusters <- quickCluster(sce) 

```

On top of normalisation the data it is also log-transformed. The log-transformation is useful as differences in the log-values represent log-fold changes in expression. Or in other words, which is more interesting - a gene that is expressed at an average count of 50 in cell type A and 10 in cell type B, or a gene that is expressed at an average count of 1100 in A and 1000 in B? Log-transformation focuses on the former by promoting contributions from genes with strong relative differences.

# Assess Confunding factors impact

Variable-level metrics are computed by the getVarianceExplained() function (after normalization). This calculates the percentage of variance of each gene’s expression that is explained by each variable in the colData of the SingleCellExperiment object. We can then use this to determine which experimental factors are contributing most to the variance in expression. This is useful for diagnosing batch effects or to quickly verify that a treatment has an effect.
```{r}
plotExplanatoryVariables(
    umi.qc[endog_genes, ],
    exprs_values = "logcounts_raw",
    variables = c(
        "total_features_by_counts",
        "total_counts",
        "batch",
        "individual",
        "pct_counts_ERCC",
        "pct_counts_MT"
    )
)
```

